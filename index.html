<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniMart - Campus Marketplace</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs (Compat version for script tag compatibility) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Firebase Config & Auth -->
    <script src="js/firebase-config.js"></script>
    <script src="js/firebase-auth.js"></script>
    
    <!-- Auth Guard -->
    <script>
        // Handle Chrome extension message passing to prevent async listener errors
        if (window.chrome && chrome.runtime) {
            chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
                sendResponse({});
                return false;
            });
        }
        
        // Wait for Firebase to be ready, then check authentication
        setTimeout(() => {
            try {
                firebase.auth().onAuthStateChanged((user) => {
                    if (!user) {
                        // User not logged in, redirect to login page
                        window.location.href = 'pages/login.html';
                    }
                });
            } catch (error) {
                console.error('Firebase not initialized:', error);
                // Fallback redirect
                window.location.href = 'pages/login.html';
            }
        }, 100);
    </script>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-placeholder">
                    <i class="fas fa-shopping-bag"></i>
                </div>
                <h1>UNIMART</h1>
            </div>

            <nav class="navigation">
                <h3>NAVIGATION</h3>
                <ul>
                    <li>
                        <a href="index.html" class="nav-item">
                            <i class="fas fa-store"></i>
                            <span>Marketplace</span>
                        </a>
                    </li>
                    <li>
                        <a href="pages/sell-item.html" class="nav-item">
                            <i class="fas fa-plus"></i>
                            <span>Sell Item</span>
                        </a>
                    </li>
                    <li>
                        <a href="pages/my-orders.html" class="nav-item">
                            <i class="fas fa-boxes"></i>
                            <span>My Orders</span>
                        </a>
                    </li>
                    <li>
                        <a href="pages/my-sales.html" class="nav-item">
                            <i class="fas fa-chart-line"></i>
                            <span>My Sales</span>
                        </a>
                    </li>
                    <li>
                        <a href="pages/my-favorites.html" class="nav-item">
                            <i class="fas fa-heart"></i>
                            <span>My Favorites</span>
                        </a>
                    </li>
                    <li>
                        <a href="pages/user-guide.html" class="nav-item">
                            <i class="fas fa-question-circle"></i>
                            <span>User Guide</span>
                        </a>
                    </li>
                    <li>
                        <a href="pages/feedback.html" class="nav-item">
                            <i class="fas fa-comment"></i>
                            <span>Feedback</span>
                        </a>
                    </li>
                    <li>
                        <a href="pages/profile.html" class="nav-item">
                            <i class="fas fa-user"></i>
                            <span>Profile</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <!-- User Profile / Login Section -->
            <div id="userSection">
                <!-- User Profile (shown when logged in) -->
                <div class="user-profile-card" id="userProfileCard" style="display: none;">
                    <div class="user-avatar-large">
                        <img id="userProfileImage" src="" alt="Profile" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; display: none;">
                        <i class="fas fa-user-circle" id="userAvatarIcon" style="font-size: 48px; color: white;"></i>
                    </div>
                    <div class="user-info">
                        <h4 id="userName">User Name</h4>
                        <p id="userEmail">user@email.com</p>
                    </div>
                    <button class="btn-logout" id="logoutBtn" onclick="handleSignOut()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Sign Out</span>
                    </button>
                </div>

                <!-- Login Button (shown when not logged in) -->
                <button class="btn-login" id="loginBtn" onclick="window.location.href='pages/login.html'" style="display: none;">
                    <i class="fab fa-google"></i>
                    <span>Sign in with Google</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header Banner -->
            <div class="header-banner">
                <h1>Campus Marketplace</h1>
                <p>The official hub for CUHK-SZ community to buy and sell items within campus</p>
            </div>

            <!-- Search and Filter Section -->
            <div class="search-filter-section">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search for items, e.g. 'textbook'...">
                </div>

                <div class="filters">
                    <select class="filter-select">
                        <option>Newest First</option>
                        <option>Oldest First</option>
                        <option>Price Low to High</option>
                        <option>Price High to Low</option>
                    </select>

                    <select class="filter-select">
                        <option>All Colleges</option>
                        <option>College 1</option>
                        <option>College 2</option>
                        <option>College 3</option>
                    </select>

                    <button class="btn-refresh">
                        <i class="fas fa-redo"></i>
                        Refresh
                    </button>
                </div>
            </div>

            <!-- Categories Section -->
            <div class="categories-section">
                <div class="category-card active">
                    <div class="category-icon">
                        <i class="fas fa-th"></i>
                    </div>
                    <span>All Items</span>
                    <span class="count">2</span>
                </div>

                <div class="category-card">
                    <div class="category-icon">
                        <i class="fas fa-book"></i>
                    </div>
                    <span>Textbooks</span>
                    <span class="count">0</span>
                </div>

                <div class="category-card">
                    <div class="category-icon">
                        <i class="fas fa-laptop"></i>
                    </div>
                    <span>Electronics</span>
                    <span class="count">0</span>
                </div>

                <div class="category-card">
                    <div class="category-icon">
                        <i class="fas fa-chair"></i>
                    </div>
                    <span>Furniture</span>
                    <span class="count">0</span>
                </div>

                <div class="category-card">
                    <div class="category-icon">
                        <i class="fas fa-shirt"></i>
                    </div>
                    <span>Clothing</span>
                    <span class="count">0</span>
                </div>

                <div class="category-card">
                    <div class="category-icon">
                        <i class="fas fa-basketball-ball"></i>
                    </div>
                    <span>Sports</span>
                    <span class="count">0</span>
                </div>

                <div class="category-card">
                    <div class="category-icon">
                        <i class="fas fa-pen"></i>
                    </div>
                    <span>Stationery</span>
                    <span class="count">0</span>
                </div>

                <div class="category-card">
                    <div class="category-icon">
                        <i class="fas fa-utensils"></i>
                    </div>
                    <span>Kitchen</span>
                    <span class="count">0</span>
                </div>

                <div class="category-card">
                    <div class="category-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <span>Vehicles</span>
                    <span class="count">0</span>
                </div>

                <div class="category-card">
                    <div class="category-icon">
                        <i class="fas fa-box"></i>
                    </div>
                    <span>Other</span>
                    <span class="count">2</span>
                </div>
            </div>

            <!-- Products Grid -->
            <div class="products-section">
                <h2>Featured Items</h2>
                <div class="products-grid" id="productsGrid">
                    <!-- Products will be dynamically loaded here -->
                </div>
            </div>

            <!-- Scroll to Top Button -->
            <button class="scroll-to-top" id="scrollToTopBtn" title="Scroll to top">
                <i class="fas fa-arrow-up"></i>
            </button>
        </main>

        <!-- Product Detail Modal -->
        <div class="product-modal" id="productModal">
            <div class="modal-overlay" id="modalOverlay"></div>
            <div class="modal-content">
                <button class="modal-close" id="modalCloseBtn">
                    <i class="fas fa-times"></i>
                </button>

                <div class="modal-body">
                    <!-- Image Carousel -->
                    <div class="modal-image-section">
                        <div class="image-carousel">
                            <button class="carousel-btn prev-btn" id="prevBtn">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="carousel-image" id="carouselImage">ðŸ“±</div>
                            <button class="carousel-btn next-btn" id="nextBtn">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="badge-group">
                            <span class="badge" id="modalBadge">Brand New</span>
                        </div>
                    </div>

                    <!-- Product Details -->
                    <div class="modal-details-section">
                        <h2 id="modalProductTitle">Product Title</h2>
                        <div class="modal-price" id="modalProductPrice">$0.00</div>

                        <!-- Seller Info -->
                        <div class="seller-info">
                            <div class="seller-item">
                                <i class="fas fa-user-circle"></i>
                                <span id="modalSeller">Seller Name</span>
                            </div>
                            <div class="seller-item">
                                <i class="fas fa-check-circle" style="color: #10b981;"></i>
                                <span>Verified</span>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="modal-section">
                            <h4>Description</h4>
                            <p id="modalDescription">No description available</p>
                        </div>

                        <!-- Action Buttons -->
                        <div class="modal-actions">
                            <button class="btn-order" id="modalOrderBtn">
                                <i class="fas fa-shopping-cart"></i>
                                Order Now
                            </button>
                            <button class="btn-save" id="modalSaveBtn">
                                <i class="fas fa-heart"></i>
                                Save
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/script.js"></script>

    <!-- Firebase User Display Script -->
    <script>
        // Display user info in sidebar
        firebaseAuthManager.onAuthStateChanged((user) => {
            const userProfileCard = document.getElementById('userProfileCard');
            const loginBtn = document.getElementById('loginBtn');
            
            if (user) {
                if (userProfileCard) userProfileCard.style.display = 'flex';
                if (loginBtn) loginBtn.style.display = 'none';
                
                // Update user info
                const userNameEl = document.getElementById('userName');
                const userEmailEl = document.getElementById('userEmail');
                if (userNameEl) userNameEl.textContent = user.displayName || 'User';
                if (userEmailEl) userEmailEl.textContent = user.email;
                
                // Set profile image
                const profileImage = document.getElementById('userProfileImage');
                const avatarIcon = document.getElementById('userAvatarIcon');
                
                if (user.photoURL && profileImage && avatarIcon) {
                    profileImage.src = user.photoURL;
                    profileImage.style.display = 'block';
                    avatarIcon.style.display = 'none';
                } else if (profileImage && avatarIcon) {
                    profileImage.style.display = 'none';
                    avatarIcon.style.display = 'block';
                }
            } else {
                if (userProfileCard) userProfileCard.style.display = 'none';
                if (loginBtn) loginBtn.style.display = 'flex';
            }
        });

        // Sign out function
        async function handleSignOut() {
            try {
                await firebaseAuthManager.signOut();
                window.location.href = 'pages/login.html';
            } catch (error) {
                console.error('Error signing out:', error);
                alert('Error signing out. Please try again.');
            }
        }
    </script>
</body>
</html>
